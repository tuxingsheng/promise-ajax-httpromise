{"version":3,"file":null,"sources":["../../src/promise/module/async.js","../../src/promise/module/promise.js"],"sourcesContent":["'use strict';\r\nlet queue = [];\r\n\r\nexport function async(callback) {\r\n    queue.push(callback);\r\n    if (queue.length == 1) {\r\n        setTimeout(run, 0);\r\n    }\r\n}\r\n\r\nfunction run() {\r\n    while (queue.length) {\r\n        queue[0]();\r\n        queue.shift();\r\n    }\r\n}\r\n","import {async} from './async';\r\n\r\nconst PENDING = 'pending';\r\nconst RESOLVED = 'resolved';\r\nconst REJECTED = 'rejected';\r\n\r\n\r\nexport function Promise(executor) {\r\n    this.defers = [];\r\n    // 设置默认状态\r\n    this.state = PENDING;\r\n    // 初始值为undefined\r\n    this.value = undefined;\r\n\r\n    var promise = this;\r\n\r\n    // 无法准确的判断传入的是否是一个包含了resolve和reject的函数\r\n    // 因此，只能通过try-catch进行处理\r\n    try {\r\n        executor(function (x) {\r\n            promise.resolve(x);\r\n        }, function (r) {\r\n            promise.reject(r);\r\n        });\r\n    } catch (e) {\r\n        promise.reject(e);\r\n    }\r\n}\r\n\r\nPromise.resolve = function (x) {\r\n    return new Promise(function (resolve, reject) {\r\n        resolve(x);\r\n    });\r\n};\r\n\r\nPromise.reject = function (r) {\r\n    return new Promise(function (resolve, reject) {\r\n        reject(r);\r\n    });\r\n};\r\n\r\nPromise.all = function (iterable) {\r\n    return new Promise(function (resolve, reject) {\r\n        let count = 0,\r\n            result = [];\r\n\r\n        if (iterable.length === 0) {\r\n            resolve(result);\r\n        }\r\n\r\n        function resolver(i) {\r\n            return function (x) {\r\n                result[i] = x;\r\n                count += 1;\r\n\r\n                if (count === iterable.length) {\r\n                    resolve(result);\r\n                }\r\n            };\r\n        }\r\n\r\n        for (let i = 0; i < iterable.length; i++) {\r\n            Promise.resolve(iterable[i]).then(resolver(i), reject);\r\n        }\r\n    })\r\n};\r\n\r\nPromise.race = function (iterable) {\r\n    return new Promise(function (resolve, reject) {\r\n        for (let i = 0; i < iterable.length; i++) {\r\n            Promise.resolve(iterable[i]).then(resolve, reject);\r\n        }\r\n    });\r\n};\r\n\r\nconst $promise = Promise.prototype;\r\n\r\n$promise.constructor = Promise;\r\n\r\n$promise.resolve = function (x) {\r\n    const promise = this;\r\n\r\n    if (x != promise) {\r\n\r\n        // 如果传入的是一个Promise\r\n        if (x instanceof Promise) {\r\n\r\n            let called = false,\r\n                then = x && x['then'];\r\n\r\n            if (x && typeof x === 'object' && typeof then === 'function') {\r\n                then.call(x, function (x) {\r\n                    if (!called) {\r\n                        promise.resolve(x);\r\n                    }\r\n                    called = true;\r\n                }, function (r) {\r\n                    if (!called) {\r\n                        promise.reject(r);\r\n                    }\r\n                    called = true;\r\n                });\r\n                return;\r\n            }\r\n        }\r\n\r\n        promise.state = RESOLVED;\r\n        promise.value = x;\r\n        promise.notify();\r\n    }\r\n};\r\n\r\n$promise.reject = function (r) {\r\n    const promise = this;\r\n\r\n    if (r != promise) {\r\n        promise.state = REJECTED;\r\n        promise.value = r;\r\n        promise.notify();\r\n    }\r\n};\r\n\r\n$promise.then = function (onResolved, onRejected) {\r\n    const promise = this;\r\n\r\n    return new Promise(function (resolve, reject) {\r\n        promise.defers.push({\r\n            onResolved: onResolved,\r\n            onRejected: onRejected,\r\n            resolve: resolve,\r\n            reject: reject\r\n        });\r\n        promise.notify();\r\n    });\r\n};\r\n\r\n$promise.catch = function (onRejected) {\r\n    return this.then(undefined, onRejected);\r\n};\r\n\r\n$promise.notify = function () {\r\n    const promise = this;\r\n\r\n    async(function () {\r\n        if (promise.state != PENDING) {\r\n            while (promise.defers.length) {\r\n                let defer = promise.defers.shift(),\r\n                    onResolved = defer.onResolved,\r\n                    onRejected = defer.onRejected,\r\n                    resolve = defer.resolve,\r\n                    reject = defer.reject;\r\n\r\n                // 如果是resolve状态\r\n                if (promise.state === RESOLVED) {\r\n                    if (isFunction(onResolved)) {\r\n                        resolve(onResolved.call(null, promise.value));\r\n                    } else {\r\n                        resolve(promise.value);\r\n                    }\r\n                }\r\n\r\n                // 如果是reject状态\r\n                if (promise.state === REJECTED) {\r\n                    if (isFunction(onRejected)) {\r\n                        reject(onRejected.call(null, promise.value));\r\n                    } else {\r\n                        reject(promise.value);\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    });\r\n};\r\n\r\nfunction isFunction(obj) {\r\n    return typeof obj === 'function';\r\n}\r\n"],"names":["queue","async","callback","push","length","run","shift","PENDING","RESOLVED","REJECTED","Promise","executor","defers","state","value","undefined","promise","x","resolve","r","reject","e","all","iterable","count","result","resolver","i","then","race","$promise","prototype","constructor","called","call","notify","onResolved","onRejected","catch","defer","isFunction","obj"],"mappings":"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"}